<?php

define('REG_DESCRIPTION', [
  'ИП' => 'P21001',
  'ООО' => 'P11001',
  'ИзмИП' => 'P24001',
  'ИзмООО' => 'P13014'
]);

module_load_include('inc', 'b_stats', 'b_stats.faker');

function b_stats_menu()
{
  $items = array();

  $items['stats'] = array(
    'title' => 'Статистика заявок',
    'page callback' => array('b_stats_theme_render_callback'),
    'access arguments' => array('access content'),
  );

  $items['full_stats'] = array(
    'title' => 'Полная статистика заявок',
    'page callback' => array('b_stats_full_theme_render_callback'),
    'access arguments' => array('access content'),
  );

  return $items;
}

function b_stats_theme_render_callback()
{
  $content = b_stats_faker_statistics_generator(rand(3, 8));

  $content = [
    'main_data_list' => prepare_main_data_list($content)
  ];

  return theme_render_template('sites/all/modules/custom/b_stats/theme/main.tpl.php', $content);
}

function b_stats_full_theme_render_callback()
{
  $content = b_stats_faker_statistics_generator(rand(3, 8));

  $content = [
    'full_data_list' => prepare_full_data_list($content)
  ];
  
  return theme_render_template('sites/all/modules/custom/b_stats/theme/themplate.tpl.php', $content);
}

function prepare_full_data_list($list)
{ 
  $result_array=[];
  foreach ($list as $record) {
    $main_info_array = [];
    $extra_info_array=[];

    $main_info_array['Id'] = [
      'col' => 'ID',
      'val' => $record['ID']
    ];

    $main_info_array['Full_name'] = [
      'col' => 'ФИО',
      'val' => implode(' ', array_filter([$record['First_name'], $record['Second_name'], $record['Third_name']]))
    ];

    $main_info_array['Inn'] = [
      'col' => 'ИНН',
      'val' => $record['Inn']
    ];

    $main_info_array['Email'] = [
      'col' => 'Email',
      'val' => $record[8]
    ];

    $extra_info_array['Phone_number'] = [
      'col' => 'Номер телефона',
      'val' => $record['Phone']
    ];

    $extra_info_array['Reg_form'] = [
      'col' => 'Форма регистрации',
      'val' => (array_search($record['Reg_form'], REG_DESCRIPTION))
    ];

    $extra_info_array['Snils'] = [
      'col' => 'СНИЛС',
      'val' => $record['Snils']
    ];

    $extra_info_array['Birthday'] = [
      'col' => 'Дата рождения',
      'val' => $record['Bday']
    ];

    $extra_info_array['Sex'] = [
      'col' => 'Пол',
      'val' => $record['Sex']
    ];

    $extra_info_array['Address'] = [
      'col' => 'Адрес',
      'val' => $record['Address']
    ];

    $result_array[$record['ID']]=[
      'main_info' => ['title' => 'Основная информация','value' => $main_info_array,],
      'extra_info' => ['title' => 'Дополнительная информация','value' => $extra_info_array]];
  }
  return $result_array;
}


function convert_array_for_main_data($record)
{
  $converted_record = [];
  $converted_record['Id'] = [
    'col' => 'ID',
    'val' => $record['ID']
  ];

  $converted_record['full_name'] = [
    'col' => 'ФИО',
    'val' => implode(' ', array_filter([$record['First_name'], $record['Second_name'], $record['Third_name']]))
  ];

  $converted_record['inn'] = [
    'col' => 'ИНН',
    'val' => $record['Inn']
  ];

  $converted_record['email'] = [
    'col' => 'Email',
    'val' => $record['Email']
  ];

  $converted_record['Phonenumber'] = [
    'col' => 'Номер телефона',
    'val' => $record['Phone']
  ];

  $converted_record['reg_form'] = [
    'col' => 'Форма регистрации',
    'val' => (array_search($record['Reg_form'], REG_DESCRIPTION))
  ];

  return $converted_record;
}

function prepare_main_data_list($list)
{
  return (array_map('convert_array_for_main_data', $list));
}